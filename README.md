# Malware-Analysis
Malware Analysis (Trickbot)
Analysis of Trickbot malware

TrickBot is a banking malware that has been in operation since 2016. It is primarily used to steal banking credentials, but it can also be used for other malicious purposes such as credential theft, information stealing, and malware distribution (Celik and Gezer, 2019). TrickBot is often delivered through phishing emails, exploit kits, or by other malware such as Emotet. Once installed on a system, TrickBot can spread laterally across the network and create backdoors for remote access.

Trickbot is commonly spread via malspam, where the emails in these campaigns provide links that appear to be legitimate invoices or documents for download, but actually contain malicious files. These files may come in the form of Windows executable files for Trickbot, or they could be a downloader intended for the Trickbot executable. Sometimes, the links in these emails lead to a zip archive that carries a Trickbot executable or downloader (Gezer et al., 2019). Trickbot is able to self-propagate within a network, allowing it to spread rapidly and infect multiple systems. It is also able to steal a wide range of sensitive data, including browser history, email credentials, and financial information.

Trickbot is a serious threat to individuals and organizations as it can steal sensitive information, launch ransomware attacks, and self-propagate within a network. These risks can lead to financial loss, identity theft, and significant disruption to operations. To mitigate these risks, individuals and organizations should prioritize cybersecurity education and training for employees, implement antivirus software and firewalls, regularly update software, and conduct regular system audits to identify and address vulnerabilities. By taking these steps, individuals and organizations can better protect themselves against Trickbot and other malware threats.

In the context of Cybersecurity, analyzing malware traffic using tools like Wireshark can help security analysts identify potential threats and vulnerabilities in the network. By analyzing network traffic associated with TrickBot, security analysts can identify the domains and IP addresses used by the malware, the protocols it uses to communicate with its command and control servers, and the data it exfiltrates from infected systems. This information can then be used to develop effective strategies for mitigating the threat and protecting the organization's critical infrastructure.













Analysis using Wireshark
In this analysis, an email was sent to a target host, the email contained a hyperlink that led to a zip archive. Within the zip archive, there was a Windows shortcut file designed to retrieve a Trickbot executable
 
<img width="412" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/b667d653-a6e0-4f54-900d-f726e08019bf">

Figure 2.1: How Trickbot works.


Wireshark was used to capture traffic from the Windows infected host. The pcap file generated from the traffic was used for this analysis 
 
<img width="372" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/2c201004-4861-4ca2-a175-f5a10bfdfc2e">

Figure 2.2: Pcap file generated from infected system

Firstly, after using DNS filter, a DNS query going to “ident.me” was found. This is a website for checking system IP address and a malware would check this to further gain information about the host.

<img width="409" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/bd38cc2f-a374-4b31-b100-42c9d19b78b9">

Figure 2.3: IP check was conducted on the host system.

Then HTTP filter was applied, and an HTTP request sent to 23.229.232.193 was observed which returned a zip file. The zip file containing “InvoiceAndStatement.Ink” was exported using wireshark. The exported Zip file was analyzed with terminal on a Kali Linux system which confirmed the file was a zip file and generated its hash value. 

<img width="344" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/fb2f7f6b-60a7-4020-9f00-b301afb232ab">

Figure 2.4: Analyzing an HTTP request which returned a Zip file

<img width="342" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/b90ecb55-3b2f-457d-9045-b6a691601ad3">
 
Figure 2.5: HTTP stream of the zip packet

<img width="373" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/1d6a0adc-8658-494b-a723-8d9019eda151">
 
Figure 2.6: Exporting the zip file for analysis on Linux terminal

<img width="341" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/b8ec8cba-e961-4287-beba-8bb322cc1e05">

Figure 2.7: Using terminal to confirm file type

Following this on the packet list, an HTTP request was sent to 144.91.69.195 shortly after which returned a windows executable file (.exe)  which is the .exe for Trickbot. Kali Terminal was used to confirm the file type after exporting it.

<img width="379" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/b9c8f48b-ade8-47a6-96c3-220f4f5c63a0">

Figure 2.8: Identification of .exe file

<img width="351" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/8bb63510-7718-4d40-8716-a9e540b04d52">
 
Figure 2.9: Analyzing the .exe packet

<img width="357" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/5d5957ce-fa0b-4f50-ae91-f6b2e838696c">
 
Figure 2.10: Confirming the file type using terminal

Once the .exe is executed, the system is being infected with Trickbot.

POST TRAFFIC ANALYSIS
Following a successful execution of the .exe which causes the Trickbot infection, the initial traffic primarily involves SSL through ports 443, 447 and 449, along with an IP address query performed by the compromised Windows host. In the current instance of infection, after the HTTP request for the .exe file, multiple TCP connection attempts through port 443 to various IP addresses can be observed, prior to a successful TCP connection to 187.58.56.26 over port 449. To view these attempted connections, applying a filter “(http.request or ssl.handshke.type ==1 or tcp.flags eq 0x0002) and !(ssdp)”can be used to filter out the connection traffic. 

<img width="363" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/054f0c9d-03be-4c72-9529-212ec52a8923">
 
Figure 2.11: Connection attempts through port 443 after infection

<img width="363" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/e896525d-7bd3-47a3-af92-98c5206d32ec">
 
Figure 2.12: IP check on ident.me after connection was established over port 449

Following this was an HTTP traffic GET request for updating list of trusted root certificates in Windows. This was done by Trickbot to update certificates in the host system.

 <img width="282" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/f437ab6d-d0dd-4344-b39c-298de5ad0145">

Figure 2.13: HTTP request to update list of trusted root certificates

After this, unusual certificate information was observed with the SSL traffic that was sent to different IP addresses through TCP ports 447 and 449. To investigate the certificate issuer, applying a filter "ssl.handshake.type == 11" for Wireshark was used. Afterward, the certificate issuer data for the first certificate after the infection was observed.

<img width="280" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/96c208f5-de9d-44ae-8264-437318cef9a7">
 
Figure 2.14: Confirming certificate data in the traffic

 <img width="287" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/1a982840-7ff6-4b31-807c-2ff3f399f45f">

Figure 2.15: Analyzing certificate data

Comparing this to other certificates issued through port 443, Some-State and Internet Widgits does not look like a legitimate SSL traffic. This is indicating that it is a malicious traffic. An example of a legitimate certificate from Microsoft is seen below.

<img width="307" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/cc7ce530-4889-426b-a61b-ebbc13eb8ca5">
 
Figure 2.16: Example of Microsoft certificate

Following the update was a group of HTTP POST requests sent to 170.230.117.187 over port 8082 which was done by Trickbot involving the host system information and passwords from emails and browser cache and sent to the server “cowboy” used by the Trickbot.

<img width="402" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/024b6289-360f-40d1-bf90-81e02706dcac">
 
Figure 2.17: HTTP POST requests through port 8082



The First POST traffic shows requests ending in 81 sending website, username and passwords in the browser cache over to the server Cowboy.

 <img width="320" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/22650c1d-10da-4e8b-b766-6b929189e92d">

Figure 2.18: First HTTP POST request stream

The second POST traffic shows requests ending in 83 sending form data submitted by the web browser to the server Cowboy.

<img width="320" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/90c0722c-c210-4a5c-82a1-a9b5a125dccb">
 
Figure 2.19: Second HTTP POST request stream

The third POST traffic shows request ending in 90 sending the system process list, system info, IP configuration and information about the host system over to the server Cowboy 

<img width="277" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/fe074dc4-b3bc-45c7-b5f6-c4a2d78ec889">
 
Figure 2.20: Third HTTP POST request stream

 <img width="333" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/6b402a66-38fb-4d8a-b51d-7221e10f045c">

Figure 2.21: More information on Third HTTP POST request stream

Following this, additional Windows executable files were transmitted by Trickbot via HTTP GET requests which appeared as .png files but were .exe files. These subsequent Trickbot executables serve to compromise a vulnerable domain controller (DC) when the infected Windows host functions as a client in an Active Directory environment.

<img width="363" alt="image" src="https://github.com/lilkhaleef/Malware-Analysis/assets/145224160/c06e0d10-5ee8-4903-b289-57ad9a15dbcd">
 
Figure 2.22: Windows .exe file hidden under a .png file


After reviewing the traffic generated, some activities were observed:

•	The compromised Windows host conducted an IP Address query.
•	Generation of SSL traffic through ports 447 and 449.
•	Generation of HTTP POST traffic through TCP port 8082
•	Issuing HTTP GET request that have a ".png" extension, which ultimately lead to the retrieval of Windows executable files.

In conclusion, this shows that Trickbot was communicating with a command and control (C&C) server, likely to receive further instructions or send stolen data. It is also capable of stealing a range of sensitive information, including login credentials, financial information, browser history, and email credentials. The malware could also exfiltrate data through multiple channels, such as email, HTTP, and DNS. Trickbot was also capable of executing other malicious activities, such as installing additional malware and modifying system settings.

